class FileSystemManager{constructor(e,t={}){this.model=e,this.defaultFileName=t.defaultFileName||`${e.name}_backup`,this.supportInfo=this.checkCompatibility()}static isSupported(){return"showOpenFilePicker"in window&&"showSaveFilePicker"in window&&"FileSystemFileHandle"in window}checkCompatibility(){return{fullSupport:FileSystemManager.isSupported(),browserInfo:{isChrome:/Chrome/.test(navigator.userAgent),isFirefox:/Firefox/.test(navigator.userAgent),isSafari:/Safari/.test(navigator.userAgent)&&!/Chrome/.test(navigator.userAgent),isEdge:/Edge/.test(navigator.userAgent)},recommendedAction:this.getRecommendedAction()}}getRecommendedAction(){return FileSystemManager.isSupported()?null:"Su navegador no soporta completamente la API de Sistema de Archivos. Se utilizará un método de descarga alternativo."}_fallbackExport(e){const t=JSON.stringify({modelName:this.model.name,timestamp:(new Date).toISOString(),data:e},null,2),a=new Blob([t],{type:"application/json"}),i=URL.createObjectURL(a),o=document.createElement("a");return o.href=i,o.download=`${this.defaultFileName}_${(new Date).toISOString().replace(/:/g,"-")}.irisdb`,document.body.appendChild(o),o.click(),document.body.removeChild(o),URL.revokeObjectURL(i),{success:!0,method:"fallback",recordsExported:e.length}}async exportToFile(){try{const e=await this.model.find();if(!FileSystemManager.isSupported())return this._fallbackExport(e);const t={types:[{description:"Iris Database Backup",accept:{"application/json":[".irisdb"]}}],suggestedName:`${this.defaultFileName}_${(new Date).toISOString().replace(/:/g,"-")}.irisdb`},a=await window.showSaveFilePicker(t),i=await a.createWritable(),o={modelName:this.model.name,timestamp:(new Date).toISOString(),data:e};return await i.write(JSON.stringify(o,null,2)),await i.close(),{success:!0,recordsExported:e.length,fileName:a.name,method:"native"}}catch(e){if(!FileSystemManager.isSupported())try{const e=await this.model.find();return this._fallbackExport(e)}catch(e){}return{success:!1,error:e.message,supportInfo:this.supportInfo}}}async _fallbackImport(){return new Promise(((e,t)=>{const a=document.createElement("input");a.type="file",a.accept=".json,.irisdb",a.onchange=async a=>{try{const t=a.target.files[0],i=await t.text(),o=JSON.parse(i);if(o.modelName!==this.model.name)throw new Error("El archivo no corresponde a este modelo de base de datos");if(await this._confirmClearExistingData()){const e=await this.model.find();for(const t of e)await this.model.delete(t[this.model.primary])}const s=[];for(const e of o.data){const t=await this.model.create(e,{castToScheme:!0});s.push(t)}e({success:!0,method:"fallback",recordsImported:s.length,timestamp:o.timestamp})}catch(e){t({success:!1,error:e.message})}},document.body.appendChild(a)}))}async importFromFile(){try{if(!FileSystemManager.isSupported())return await this._fallbackImport();const[e]=await window.showOpenFilePicker({types:[{description:"Iris Database Backup",accept:{"application/json":[".irisdb"]}}],multiple:!1}),t=await e.getFile(),a=await t.text(),i=JSON.parse(a);if(i.modelName!==this.model.name)throw new Error("El archivo no corresponde a este modelo de base de datos");if(await this._confirmClearExistingData()){const e=await this.model.find();for(const t of e)await this.model.delete(t.id)}const o=[];for(const e of i.data){const t=await this.model.create(e);o.push(t)}return{success:!0,recordsImported:o.length,fileName:e.name,timestamp:i.timestamp,method:"native"}}catch(e){if(!FileSystemManager.isSupported())try{return await this._fallbackImport()}catch(e){}return{success:!1,error:e.message,supportInfo:this.supportInfo}}}async _confirmClearExistingData(){return new Promise((e=>{e(confirm("¿Desea eliminar los datos existentes antes de importar?"))}))}setupAutoBackup(e=864e5){return setInterval((async()=>{try{await this.exportToFile()}catch(e){}}),e)}}export{FileSystemManager};